name: Setup VerseCrafter

on:
  workflow_dispatch:
    inputs:
      install_flash_attn:
        description: "Install flash-attn (usually needs CUDA build toolchain)"
        required: false
        default: "false"
      use_cuda:
        description: "Install CUDA PyTorch (requires GPU runner; usually self-hosted)"
        required: false
        default: "false"

  push:
    paths:
      - ".github/workflows/setup-versecrafter.yml"
      - "requirements.txt"
      - "**/*.py"

jobs:
  setup:
    runs-on: ubuntu-latest

    env:
      # уменьшает расход диска на кэш pip
      PIP_NO_CACHE_DIR: "1"
      # переносим conda package cache в workspace (а не в /home/runner/conda_pkgs_dir)
      CONDA_PKGS_DIRS: ${{ github.workspace }}/conda_pkgs_dir
      # временные файлы сборки тоже в workspace
      TMPDIR: ${{ github.workspace }}/.tmp

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Disk check (start)
        run: df -h

      # Освобождаем место на ubuntu-latest, иначе conda+pytorch часто падают с Errno 28
      - name: Free disk space
        shell: bash
        run: |
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo docker image prune --all --force || true
          sudo docker builder prune -a -f || true
          df -h

      - name: Prepare dirs
        shell: bash
        run: |
          mkdir -p "${{ github.workspace }}/conda_pkgs_dir" "${{ github.workspace }}/.tmp"
          ls -la

      - name: DEBUG - структура репозитория (до установки)
        shell: bash
        run: |
          pwd
          echo "=== ROOT ==="
          ls -la
          echo "=== requirements candidates ==="
          find . -maxdepth 4 -name "requirements*.txt" -type f -print
          echo "=== top dirs ==="
          find . -maxdepth 2 -type d -print | sed 's|^\./||'

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.11"
          auto-activate-base: false
          # важно: pkgs cache в workspace
          pkgs-dirs: ${{ github.workspace }}/conda_pkgs_dir

      - name: OS build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build git

      - name: Create conda env
        shell: bash
        run: |
          source "$CONDA/etc/profile.d/conda.sh" 2>/dev/null || true
          conda create -n versecrafter python=3.11 -y

      - name: Install PyTorch (CPU)
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.use_cuda != 'true' }}
        shell: bash
        run: |
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          conda install -y pytorch==2.3.0 torchvision==0.18.0 torchaudio==2.3.0 cpuonly -c pytorch
          conda clean -a -y

      - name: Install PyTorch (CUDA 12.1)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.use_cuda == 'true' }}
        shell: bash
        run: |
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          conda install -y pytorch==2.3.0 torchvision==0.18.0 torchaudio==2.3.0 pytorch-cuda=12.1 -c pytorch -c nvidia
          conda clean -a -y

      - name: Install Python dependencies
        shell: bash
        run: |
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install MoGe (retry)
        shell: bash
        run: |
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          git config --global http.postBuffer 524288000
          for i in 1 2 3 4 5; do
            pip install git+https://github.com/microsoft/MoGe.git && break
            echo "MoGe install failed, retry $i/5..."
            sleep $((i*15))
          done

      - name: Debug folders (after deps)
        shell: bash
        run: |
          pwd
          ls -la
          find . -maxdepth 3 -type d | sed 's|^\./||'

      - name: Install Grounded-SAM-2
        shell: bash
        env:
          TMPDIR: ${{ github.workspace }}/.tmp
        run: |
          mkdir -p "$TMPDIR"
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          cd third_party/Grounded-SAM-2
          pip install -e . --no-build-isolation
          pip install --no-build-isolation -e grounding_dino

      - name: Install flash-attn (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.install_flash_attn == 'true' }}
        shell: bash
        run: |
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          pip install flash-attn --no-build-isolation

      - name: Install pytorch3d (from source)
        shell: bash
        env:
          TMPDIR: ${{ github.workspace }}/.tmp
        run: |
          mkdir -p "$TMPDIR"
          source "$CONDA/etc/profile.d/conda.sh"
          conda activate versecrafter
          git clone https://github.com/facebookresearch/pytorch3d.git
          cd pytorch3d
          pip install --no-build-isolation .
          cd ..

      - name: Disk check (end)
        if: always()
        run: df -h
